import{e as d}from"./index-BmhwsXu_.js";class R{constructor(){this.societyDetails=null,this.templateStructure=null,this.headerMergeRange=null}setSocietyDetails(e,t){this.societyDetails={societyName:e,...t}}setHeaderMergeRange(e){this.headerMergeRange=e}async generateReceiptRegister({data:e,template:t,societyName:r,societyDetails:o={},headerMergeRange:s="A:H"}){try{console.log("üßæ Generating Receipt Register..."),this.setSocietyDetails(r,o),this.setHeaderMergeRange(s);const i=await this.processTemplate(t);await this.analyzeTemplateStructure(i);const n=this.prepareReceiptData(e);if(n.length===0)throw new Error("No receipt data found. Please ensure records have receipt amounts greater than 0.");const a=new d.Workbook;a.creator="Gawde Account Service - Receipt Register",a.created=new Date,await this.generateReceiptRegisterSheet(a,i,n);const l=this.generateFilename(r),c=await a.xlsx.writeBuffer();return this.downloadExcelFile(c,l),{success:!0,filename:l,recordCount:n.length,reportType:"Receipt Register",templateFlavor:this.templateStructure.flavor,totalReceiptAmount:this.calculateTotalReceipts(n),headerMergeRange:this.headerMergeRange}}catch(i){return console.error("‚ùå Receipt register generation error:",i),{success:!1,error:i.message}}}async processTemplate(e){const t=await e.arrayBuffer(),r=new d.Workbook;return await r.xlsx.load(t),r}async analyzeTemplateStructure(e){const t=e.worksheets[0],r=3,o=5,s=this.determineTemplateFlavor(t,o),i=this.getDataTemplateRows(t,o,s);this.templateStructure={headerEndRow:r,dataStartRow:o,dataTemplateRows:i,flavor:s},console.log(`üìã Template analysis: Flavor=${s}, DataStart=${o}`)}determineTemplateFlavor(e,t){let r=0;for(let o=t;o<=t+4;o++){const s=e.getRow(o);let i=!1;if(s.eachCell(n=>{const a=this.getCellValue(n);typeof a=="string"&&a.includes("${")&&(i=!0)}),i)r++;else if(r>0)break}return console.log(`üîç Found ${r} consecutive template rows`),r>=3?"multi":"single"}getDataTemplateRows(e,t,r){const o=[];if(r==="multi"){for(let s=0;s<5;s++){const i=t+s;if(i<=e.rowCount){const n=e.getRow(i);let a=!1;if(n.eachCell(l=>{const c=this.getCellValue(l);typeof c=="string"&&c.includes("${")&&(a=!0)}),a)o.push(i);else if(o.length>0)break}}if(o.length<3){o.length=0;for(let s=0;s<3;s++)o.push(t+s)}}else o.push(t);return o}prepareReceiptData(e){return e.filter(t=>{const r=parseFloat(t.REC_AMT)||0,o=parseFloat(t.REC_AMT1)||0,s=parseFloat(t.REC_AMT2)||0,i=parseFloat(t.REC_AMT3)||0;return r>0||o>0||s>0||i>0})}async generateReceiptRegisterSheet(e,t,r){const o=t.worksheets[0],s=e.addWorksheet("Receipt Register");this.copyPageSetup(o,s),this.copyColumnProperties(o,s);let i=1;this.createSimpleHeaderRows(s,o,i),i+=3,this.copyRow(o,s,4,i,null),i++;for(let n=0;n<r.length;n++){const a=r[n];if(console.log(`üìÑ Processing record ${n+1}/${r.length}: CODE_NO ${a.CODE_NO}`),this.templateStructure.flavor==="single")this.copyRow(o,s,this.templateStructure.dataStartRow,i,a),i++;else{const l=this.generateMultiRowReceipt(o,s,a,i);i+=l}}console.log(`‚úÖ Receipt register generated: ${r.length} records`)}createSimpleHeaderRows(e,t,r){console.log(`üìã Creating simple header rows starting at ${r}`),console.log(`üìã Using merge range: ${this.headerMergeRange}`);for(let a=1;a<=3;a++){const l=t.getRow(a),c=e.getRow(r+a-1);l.height&&(c.height=l.height);let u="";if(l.eachCell({includeEmpty:!1},h=>{if(!u&&h.value)return u=this.getCellValue(h),!1}),u){const h=c.getCell(1);h.value=u;const g=l.getCell(1);g.style&&(h.style=this.copyStyle(g.style)),console.log(`üìã Row ${a}: "${u}"`)}c.commit()}const o=r,s=this.headerMergeRange||"A:H",[i,n]=this.parseMergeRange(s);try{const a=`${i}${o}:${n}${o}`;e.mergeCells(a),console.log(`üìã Merged row ${o} society name ${a}`)}catch(a){console.warn("Could not merge society name row:",a.message)}try{const a=`${i}${o+1}:${n}${o+1}`;e.mergeCells(a),console.log(`üìã Merged row ${o+1} register title ${a}`)}catch(a){console.warn("Could not merge register title row:",a.message)}}parseMergeRange(e){try{if(e.includes(":")){const[t,r]=e.split(":");return[t.trim(),r.trim()]}else return["A",e.trim()]}catch{return console.warn("Invalid merge range format, using A:H as fallback:",e),["A","H"]}}generateMultiRowReceipt(e,t,r,o){const s=this.templateStructure.dataTemplateRows;let i=0;console.log(`üîÑ Generating 3 rows for CODE_NO ${r.CODE_NO}`);for(let n=0;n<3;n++){const a=Math.min(n,s.length-1),l=s[a],c=this.createMonthRecord(r,n+1);this.copyRow(e,t,l,o+i,c),i++}return i}createMonthRecord(e,t){const r={...e},o=`CHEQUE_NO${t}`,s=`CHEQUE_DT${t}`,i=`BANK${t}`,n=`REC_AMT${t}`;return r.CHEQUE_NO=e[o]||"",r.CHEQUE_DT=e[s]||"",r.CHQ_DATE=e[s]||"",r.BANK=e[i]||"",r.REC_AMT=e[n]||"",r.RECEIPT_AMOUNT=e[n]||"",t>1&&(r.CODE_NO="",r.FLAT_NO="",r.NAME=""),r}copyRow(e,t,r,o,s){const i=e.getRow(r),n=t.getRow(o);i.height&&(n.height=i.height),i.eachCell({includeEmpty:!0},(a,l)=>{const c=n.getCell(l);a.style&&(c.style=this.copyStyle(a.style));let u;s?u=this.processTemplateValue(a.value,s):u=a.value,u!=null&&(c.value=u)}),n.commit()}processTemplateValue(e,t){return e?t&&typeof e=="string"&&e.includes("${")?this.replaceVariables(e,t):e:""}replaceVariables(e,t){if(typeof e!="string")return e;const r=/\$\{([A-Z_][A-Z0-9_]*)\}/g;return e.replace(r,(o,s)=>{const i=t[s];return i==null||i===""?"":this.isCurrencyField(s)?this.formatCurrency(i):this.isDateField(s)?this.formatDate(i):String(i)})}getCellValue(e){if(!e||!e.value)return"";if(typeof e.value=="string")return e.value;if(e.value&&typeof e.value=="object"){if(e.value.richText&&Array.isArray(e.value.richText))return e.value.richText.map(t=>t.text||"").join("");if(e.value.text)return e.value.text;if(e.value.result!==void 0)return String(e.value.result)}return String(e.value)}copyPageSetup(e,t){try{e.pageSetup&&(t.pageSetup=JSON.parse(JSON.stringify(e.pageSetup)))}catch{console.warn("Could not copy page setup")}}copyColumnProperties(e,t){e.columns.forEach((r,o)=>{if(r)try{const s=t.getColumn(o+1);r.width&&(s.width=r.width),r.hidden&&(s.hidden=r.hidden)}catch{console.warn(`Could not copy column ${o+1}`)}})}copyStyle(e){try{const t={};return e.font&&(t.font={...e.font}),e.alignment&&(t.alignment={...e.alignment}),e.border&&(t.border=JSON.parse(JSON.stringify(e.border))),e.fill&&(t.fill=JSON.parse(JSON.stringify(e.fill))),e.numFmt&&(t.numFmt=e.numFmt),t}catch{return{}}}isCurrencyField(e){return["REC_AMT","REC_AMT1","REC_AMT2","REC_AMT3","RECEIPT_AMOUNT","TOTAL","GR_TOTAL","ARREARS","ADVANCE","OUTST_BAL"].includes(e)}isDateField(e){return["REC_DATE","CHEQUE_DT","CHEQUE_DT1","CHEQUE_DT2","CHEQUE_DT3","CHQ_DATE"].includes(e)}formatCurrency(e){const t=parseFloat(e);return isNaN(t)?"0":t.toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2})}formatDate(e){if(!e)return"";try{const t=new Date(e);return isNaN(t.getTime())?e:t.toLocaleDateString("en-IN")}catch{return e}}calculateTotalReceipts(e){return e.reduce((t,r)=>{const o=parseFloat(r.REC_AMT)||0,s=parseFloat(r.REC_AMT1)||0,i=parseFloat(r.REC_AMT2)||0,n=parseFloat(r.REC_AMT3)||0;return t+o+s+i+n},0)}generateFilename(e){const t=new Date().toISOString().split("T")[0];return`${e?e.replace(/[^a-zA-Z0-9]/g,"_"):"Society"}_ReceiptRegister_${t}.xlsx`}downloadExcelFile(e,t){const r=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=window.URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(o)}}const w=async f=>await new R().generateReceiptRegister(f);class y{constructor(){this.societyDetails=null,this.templateStructure=null,this.headerMergeRange=null,this.selectedTotalFields=[]}setSocietyDetails(e,t){this.societyDetails={societyName:e,...t}}setHeaderMergeRange(e){this.headerMergeRange=e}setSelectedTotalFields(e){this.selectedTotalFields=e||[]}async generateBillRegister({data:e,template:t,outputMode:r="single",societyName:o,societyDetails:s={},headerMergeRange:i="A:J",selectedTotalFields:n=[]}){try{console.log("üìã Generating Bill Register..."),console.log(`üìã Output Mode: ${r}`),console.log(`üìã Header Merge Range: ${i}`),this.setSocietyDetails(o,s),this.setHeaderMergeRange(i),this.setSelectedTotalFields(n);const a=await this.processTemplate(t);await this.analyzeTemplateStructure(a);const l=this.prepareBillData(e);if(l.length===0)throw new Error("No bill data found. Please ensure you have imported billing data.");const c=new d.Workbook;c.creator="Gawde Account Service - Bill Register",c.created=new Date,r==="multi"?await this.generateMultiSheetBillRegister(c,a,l):await this.generateSingleSheetBillRegister(c,a,l);const u=this.generateFilename(o,r),h=await c.xlsx.writeBuffer();return this.downloadExcelFile(h,u),{success:!0,filename:u,recordCount:l.length,reportType:"Bill Register",outputMode:r,worksheetCount:c.worksheets.length,totalAmount:this.calculateTotalBillAmount(l),headerMergeRange:this.headerMergeRange}}catch(a){return console.error("‚ùå Bill register generation error:",a),{success:!1,error:a.message}}}async processTemplate(e){const t=await e.arrayBuffer(),r=new d.Workbook;return await r.xlsx.load(t),r}async analyzeTemplateStructure(e){const t=e.worksheets[0],r=this.findHeaderEndRow(t),o=this.findDataStartRow(t,r),s=this.findDataTemplateRow(t,o),i=this.findTotalRow(t);this.templateStructure={headerEndRow:r,dataStartRow:o,dataTemplateRow:s,totalRow:i,hasTotal:i>0},console.log(`üìã Bill Template analysis: DataStart=${o}, TotalRow=${i}`)}findHeaderEndRow(e){for(let t=1;t<=5;t++){const r=e.getRow(t);let o=!1;if(r.eachCell(s=>{const i=this.getCellValue(s);i&&i.toString().trim().length>0&&(o=!0)}),!o)return t-1}return 3}findDataStartRow(e,t){for(let r=t+1;r<=e.rowCount;r++){const o=e.getRow(r);let s=!1;if(o.eachCell(i=>{const n=this.getCellValue(i);typeof n=="string"&&n.includes("${")&&(s=!0)}),s)return r}return t+2}findDataTemplateRow(e,t){for(let r=t;r<=t+3;r++){const o=e.getRow(r);let s=0;if(o.eachCell(i=>{const n=this.getCellValue(i);typeof n=="string"&&n.includes("${")&&s++}),s>=3)return r}return t}findTotalRow(e){for(let t=e.rowCount;t>=1;t--){const r=e.getRow(t);let o=!1;if(r.eachCell(s=>{const i=this.getCellValue(s);if(typeof i=="string"){const n=i.toLowerCase();(n.includes("total")||n.includes("sum"))&&(o=!0)}s.value&&typeof s.value=="object"&&s.value.formula&&s.value.formula.toUpperCase().includes("SUM")&&(o=!0)}),o)return t}return 0}prepareBillData(e){return e.sort((t,r)=>{const o=t.CODE_NO||t.FLAT_NO||"",s=r.CODE_NO||r.FLAT_NO||"";return o.localeCompare(s)})}async generateSingleSheetBillRegister(e,t,r){const o=t.worksheets[0],s=e.addWorksheet("Bill Register");this.copyPageSetup(o,s),this.copyColumnProperties(o,s);let i=1;this.createBillHeaderRows(s,o,i),i+=this.templateStructure.headerEndRow,this.copyRow(o,s,this.templateStructure.dataStartRow-1,i,null),i++;const n=i;for(let a=0;a<r.length;a++){const l=r[a];console.log(`üìÑ Processing bill ${a+1}/${r.length}: CODE_NO ${l.CODE_NO}`),this.copyRow(o,s,this.templateStructure.dataTemplateRow,i,l),i++}this.templateStructure.hasTotal&&this.createTotalRow(s,o,i,n,r.length),console.log(`‚úÖ Bill register generated: ${r.length} records`)}async generateMultiSheetBillRegister(e,t,r){const o=t.worksheets[0];for(let s=0;s<r.length;s++){const i=r[s],n=this.generateSheetName(i,s+1);console.log(`üìÑ Creating bill sheet ${s+1}/${r.length}: ${n}`);const a=e.addWorksheet(n);await this.createSingleBillSheet(o,a,i)}}async createSingleBillSheet(e,t,r){this.copyPageSetup(e,t),this.copyColumnProperties(e,t),e.eachRow({includeEmpty:!0},(o,s)=>{this.copyRow(e,t,s,s,r)}),this.copyMergedCells(e,t)}createBillHeaderRows(e,t,r){console.log(`üìã Creating bill header rows starting at ${r}`),console.log(`üìã Using merge range: ${this.headerMergeRange}`);for(let i=1;i<=this.templateStructure.headerEndRow;i++){const n=t.getRow(i),a=e.getRow(r+i-1);n.height&&(a.height=n.height);let l="";if(n.eachCell({includeEmpty:!1},c=>{if(!l&&c.value){const u=this.getCellValue(c);return l=this.replaceVariables(u,{}),!1}}),l){const c=a.getCell(1);c.value=l;const u=n.getCell(1);u.style&&(c.style=this.copyStyle(u.style)),console.log(`üìã Header Row ${i}: "${l}"`)}a.commit()}const[o,s]=this.parseMergeRange(this.headerMergeRange||"A:J");for(let i=0;i<this.templateStructure.headerEndRow;i++){const n=r+i;try{const a=`${o}${n}:${s}${n}`;e.mergeCells(a),console.log(`üìã Merged header row ${n}: ${a}`)}catch(a){console.warn(`Could not merge header row ${n}:`,a.message)}}}createTotalRow(e,t,r,o,s){console.log(`üìä Creating total row at ${r} for ${s} records`),console.log(`üìä Selected total fields: ${this.selectedTotalFields.join(", ")}`);const i=t.getRow(this.templateStructure.totalRow),n=e.getRow(r);i.height&&(n.height=i.height),i.eachCell({includeEmpty:!0},(a,l)=>{const c=n.getCell(l);a.style&&(c.style=this.copyStyle(a.style)),c.font={...c.font,bold:!0};const u=this.getCellValue(a);let h=!1,g=null;if(typeof u=="string"&&u.includes("${")){const p=u.match(/\$\{([A-Z_][A-Z0-9_]*)\}/);p&&(g=p[1],this.selectedTotalFields.includes(g)&&(h=!0))}if(a.value&&typeof a.value=="object"&&a.value.formula&&a.value.formula.toUpperCase().includes("SUM")&&this.selectedTotalFields.length>0&&(h=!0),h){const p=`${this.getColumnLetter(l)}${o}:${this.getColumnLetter(l)}${r-1}`,m=`SUMPRODUCT(--ISNUMBER(VALUE(${p})),VALUE(${p}))`;c.value={formula:m},this.isCurrencyColumn(l,a,g)&&(c.numFmt="#,##0.00"),console.log(`üìä Added VALUE-enabled SUM formula for ${g}: ${m}`)}else u&&typeof u=="string"&&u.toLowerCase().includes("total")?(c.value=u,console.log(`üìä Added total label: ${u}`)):g&&!this.selectedTotalFields.includes(g)?(c.value="",console.log(`üìä Skipped total for unselected field: ${g}`)):c.value=a.value}),n.commit()}getColumnLetter(e){let t="";for(;e>0;)e--,t=String.fromCharCode(65+e%26)+t,e=Math.floor(e/26);return t}isCurrencyColumn(e,t,r=null){if(r&&this.isCurrencyField(r))return!0;const o=this.getCellValue(t);if(t.style&&t.style.numFmt){const s=t.style.numFmt;if(typeof s=="string"&&(s.includes("#,##0")||s.includes("0.00")))return!0}if(typeof o=="string"&&o.includes("${")){const s=o.match(/\$\{([A-Z_][A-Z0-9_]*)\}/);if(s)return this.isCurrencyField(s[1])}return!1}generateSheetName(e,t){return e.FLAT_NO?`Bill_Flat_${e.FLAT_NO}`:e.CODE_NO?`Bill_Code_${e.CODE_NO}`:e.NAME?`Bill_${String(e.NAME).replace(/[^\w\s]/g,"").substring(0,15)}`||`Bill_${t}`:`Bill_${t}`}parseMergeRange(e){try{if(e.includes(":")){const[t,r]=e.split(":");return[t.trim(),r.trim()]}else return["A",e.trim()]}catch{return console.warn("Invalid merge range format, using A:J as fallback:",e),["A","J"]}}copyRow(e,t,r,o,s){const i=e.getRow(r),n=t.getRow(o);i.height&&(n.height=i.height),i.eachCell({includeEmpty:!0},(a,l)=>{const c=n.getCell(l);a.style&&(c.style=this.copyStyle(a.style));let u;s?u=this.processTemplateValue(a.value,s):u=a.value,u!=null&&(c.value=u)}),n.commit()}processTemplateValue(e,t){return e?t&&typeof e=="string"&&e.includes("${")?this.replaceVariables(e,t):e:""}replaceVariables(e,t){if(typeof e!="string")return e;const r=/\$\{([A-Z_][A-Z0-9_]*)\}/g,o=this.getSocietyVariables();return e.replace(r,(s,i)=>{if(o.hasOwnProperty(i))return o[i]||"";const n=t[i];return n==null||n===""?"":this.isCurrencyField(i)?this.formatCurrency(n):this.isDateField(i)?this.formatDate(n):String(n)})}getSocietyVariables(){return this.societyDetails?{SOCIETY_NAME:this.societyDetails.societyName||"",SOCIETY_REG_NO:this.societyDetails.regNo||"",SOCIETY_ADDRESS:this.societyDetails.address||"",BILL_MONTH_FROM:this.societyDetails.billMonthFrom||"",BILL_MONTH_TO:this.societyDetails.billMonthTo||"",BILL_YEAR:this.societyDetails.billYear?String(this.societyDetails.billYear):""}:{SOCIETY_NAME:"",SOCIETY_REG_NO:"",SOCIETY_ADDRESS:"",BILL_MONTH_FROM:"",BILL_MONTH_TO:"",BILL_YEAR:""}}getCellValue(e){if(!e||!e.value)return"";if(typeof e.value=="string")return e.value;if(e.value&&typeof e.value=="object"){if(e.value.richText&&Array.isArray(e.value.richText))return e.value.richText.map(t=>t.text||"").join("");if(e.value.text)return e.value.text;if(e.value.result!==void 0)return String(e.value.result)}return String(e.value)}copyPageSetup(e,t){try{e.pageSetup&&(t.pageSetup=JSON.parse(JSON.stringify(e.pageSetup)))}catch{console.warn("Could not copy page setup")}}copyColumnProperties(e,t){e.columns.forEach((r,o)=>{if(r)try{const s=t.getColumn(o+1);r.width&&(s.width=r.width),r.hidden&&(s.hidden=r.hidden)}catch{console.warn(`Could not copy column ${o+1}`)}})}copyStyle(e){try{const t={};return e.font&&(t.font={...e.font}),e.alignment&&(t.alignment={...e.alignment}),e.border&&(t.border=JSON.parse(JSON.stringify(e.border))),e.fill&&(t.fill=JSON.parse(JSON.stringify(e.fill))),e.numFmt&&(t.numFmt=e.numFmt),t}catch{return{}}}copyMergedCells(e,t){try{e.model&&e.model.merges&&e.model.merges.forEach(r=>{try{t.mergeCells(r)}catch{console.warn("Could not merge cells:",r)}})}catch(r){console.warn("Could not copy merged cells:",r.message)}}isCurrencyField(e){return["MAINT_CHG","WATER_CHG","BMC_TAX","ELECT_CHG","SALARY","OTHER_CHG1","OTHER_CHG2","SINK_FUND","REP_FUND","LET_OUT_CH","PARK_CHG","BLDG_FUND","LEGAL_CHG","PAINT_FD","MAPLE_CHG","LIFT_MAINT","INT_ARREAR","TOTAL","GR_TOTAL","ARREARS","ADVANCE","OUTST_BAL","REC_AMT","REC_AMT1","REC_AMT2","REC_AMT3"].includes(e)}isDateField(e){return["BILL_DATE","DUE_DATE","REC_DATE","CHEQUE_DT1","CHEQUE_DT2","CHEQUE_DT3"].includes(e)}formatCurrency(e){const t=parseFloat(e);return isNaN(t)?"0":t.toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2})}formatDate(e){if(!e)return"";try{const t=new Date(e);return isNaN(t.getTime())?e:t.toLocaleDateString("en-IN")}catch{return e}}calculateTotalBillAmount(e){return e.reduce((t,r)=>{const o=parseFloat(r.TOTAL)||0;return t+o},0)}generateFilename(e,t){const r=new Date().toISOString().split("T")[0];return`${e?e.replace(/[^a-zA-Z0-9]/g,"_"):"Society"}_BillRegister_${t==="multi"?"MultiSheet":"SingleSheet"}_${r}.xlsx`}downloadExcelFile(e,t){const r=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=window.URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(o)}}const C=async f=>await new y().generateBillRegister(f);class T{constructor(){this.societyDetails=null}setSocietyDetails(e,t){this.societyDetails={societyName:e,...t}}async generateSpecializedReport({data:e,template:t,outputMode:r,reportType:o,societyName:s,societyDetails:i={},headerMergeRange:n,selectedTotalFields:a}){try{if(console.log(`üöÄ Generating ${o} report in ${r} mode`),n&&console.log(`üìä Header merge range: ${n}`),a&&a.length>0&&console.log(`üìä Selected total fields: ${a.join(", ")}`),this.setSocietyDetails(s,i),o==="receipt"){console.log("üìã Using specialized receipt register service...");const l={data:e,template:t,societyName:s,societyDetails:i};return n&&(l.headerMergeRange=n,console.log(`üìä Passing header merge range to receipt service: ${n}`)),await w(l)}if(o==="bill"){console.log("üìã Using specialized bill register service...");const l={data:e,template:t,outputMode:r,societyName:s,societyDetails:i};return n&&(l.headerMergeRange=n,console.log(`üìä Passing header merge range to bill service: ${n}`)),a&&a.length>0&&(l.selectedTotalFields=a,console.log(`üìä Passing selected total fields to bill service: ${a.join(", ")}`)),await C(l)}return await this.generateGeneralReport({data:e,template:t,outputMode:r,reportType:o,societyName:s,societyDetails:i})}catch(l){return console.error("‚ùå Report generation error:",l),{success:!1,error:l.message}}}async generateGeneralReport({data:e,template:t,outputMode:r,reportType:o,societyName:s,societyDetails:i={}}){const n=await this.processTemplate(t),a=this.prepareDataForReport(e,o);if(a.length===0)throw new Error(`No suitable data found for ${o} report`);const l=new d.Workbook;l.creator="Gawde Account Service",l.created=new Date,r==="multi"?await this.generateMultiSheetReport(l,n,a,o):await this.generateSingleSheetReport(l,n,a,o);const c=this.generateFilename(s,o,r),u=await l.xlsx.writeBuffer();return this.downloadExcelFile(u,c),{success:!0,filename:c,recordCount:a.length,reportType:this.getReportDisplayName(o),outputMode:r,worksheetCount:l.worksheets.length}}async processTemplate(e){const t=await e.arrayBuffer(),r=new d.Workbook;return await r.xlsx.load(t),r}prepareDataForReport(e,t){switch(t){case"member":return e;case"bill":return console.warn("Bill report should use specialized service"),e;case"receipt":return console.warn("Receipt report should use specialized service"),e.filter(r=>{const o=parseFloat(r.REC_AMT)||0,s=parseFloat(r.REC_AMT1)||0,i=parseFloat(r.REC_AMT2)||0,n=parseFloat(r.REC_AMT3)||0;return o>0||s>0||i>0||n>0});default:return e}}async generateMultiSheetReport(e,t,r,o){const s=t.worksheets[0];for(let i=0;i<r.length;i++){const n=r[i],a=this.generateSheetName(n,i+1,o);console.log(`üìÑ Creating sheet ${i+1}/${r.length}: ${a}`);const l=e.addWorksheet(a);await this.createSheetFromTemplate(s,l,n)}}async generateSingleSheetReport(e,t,r,o){const s=t.worksheets[0],i=e.addWorksheet(this.getReportDisplayName(o));this.copyPageSetup(s,i),this.copyColumnProperties(s,i);let n=1;const a=s.rowCount;for(let l=0;l<r.length;l++){const c=r[l];console.log(`üìÑ Processing record ${l+1}/${r.length} at row ${n}`);for(let u=1;u<=a;u++)this.copyRow(s,i,u,n,c),n++;if(l<r.length-1)try{i.getRow(n-1).addPageBreak=!0,n+=2}catch{n+=2}}}async createSheetFromTemplate(e,t,r){this.copyPageSetup(e,t),this.copyColumnProperties(e,t),e.eachRow({includeEmpty:!0},(o,s)=>{this.copyRow(e,t,s,s,r)}),this.copyMergedCells(e,t)}copyRow(e,t,r,o,s){const i=e.getRow(r),n=t.getRow(o);i.height&&(n.height=i.height),i.eachCell({includeEmpty:!0},(a,l)=>{const c=n.getCell(l);a.style&&(c.style=this.copyStyle(a.style));const u=this.processTemplateValue(a.value,s);u!=null&&(c.value=u),this.copyOtherCellProperties(a,c)}),n.commit()}processTemplateValue(e,t){if(!e)return"";if(typeof e=="string")return e.includes("${")?this.replaceVariables(e,t):e;if(e&&typeof e=="object"&&e.richText)return{richText:e.richText.map(o=>o.text&&typeof o.text=="string"&&o.text.includes("${")?{...o,text:this.replaceVariables(o.text,t)}:o)};if(e&&typeof e=="object"&&e.formula)if(e.formula.includes("${"))try{return{formula:this.replaceVariables(e.formula,t)}}catch{return e.result||""}else return e.result!==void 0?e.result:e;if(e&&typeof e=="object"){if(e.text&&e.text.includes("${"))return{...e,text:this.replaceVariables(e.text,t)};if(e.result!==void 0)return e.result}return e}replaceVariables(e,t){if(typeof e!="string")return e;const r=/\$\{([A-Z_][A-Z0-9_]*)\}/g,o=this.getSocietyVariables();return e.replace(r,(s,i)=>{if(o.hasOwnProperty(i))return o[i]||"";const n=t[i];return n==null||n===""?"":this.isCurrencyField(i)?this.formatCurrency(n):this.isDateField(i)?this.formatDate(n):String(n)})}getSocietyVariables(){return this.societyDetails?{SOCIETY_NAME:this.societyDetails.societyName||"",SOCIETY_REG_NO:this.societyDetails.regNo||"",SOCIETY_ADDRESS:this.societyDetails.address||"",BILL_MONTH_FROM:this.societyDetails.billMonthFrom||"",BILL_MONTH_TO:this.societyDetails.billMonthTo||"",BILL_YEAR:this.societyDetails.billYear?String(this.societyDetails.billYear):""}:{SOCIETY_NAME:"",SOCIETY_REG_NO:"",SOCIETY_ADDRESS:"",BILL_MONTH_FROM:"",BILL_MONTH_TO:"",BILL_YEAR:""}}copyPageSetup(e,t){try{e.pageSetup&&(t.pageSetup=JSON.parse(JSON.stringify(e.pageSetup)))}catch(r){console.warn("Could not copy page setup:",r.message)}}copyColumnProperties(e,t){e.columns.forEach((r,o)=>{if(r)try{const s=t.getColumn(o+1);r.width&&(s.width=r.width),r.hidden&&(s.hidden=r.hidden)}catch(s){console.warn(`Could not copy column ${o+1}:`,s.message)}})}copyStyle(e){try{const t={};return e.font&&(t.font={...e.font}),e.alignment&&(t.alignment={...e.alignment}),e.border&&(t.border=JSON.parse(JSON.stringify(e.border))),e.fill&&(t.fill=JSON.parse(JSON.stringify(e.fill))),e.numFmt&&(t.numFmt=e.numFmt),t}catch{return{}}}copyOtherCellProperties(e,t){try{e.dataValidation&&(t.dataValidation=JSON.parse(JSON.stringify(e.dataValidation))),e.hyperlink&&(t.hyperlink=e.hyperlink),e.note&&(t.note=e.note)}catch{}}copyMergedCells(e,t){try{e.model&&e.model.merges&&e.model.merges.forEach(r=>{try{t.mergeCells(r)}catch{console.warn("Could not merge cells:",r)}})}catch(r){console.warn("Could not copy merged cells:",r.message)}}generateSheetName(e,t,r){switch(r){case"bill":return e.FLAT_NO?`Bill_Flat_${e.FLAT_NO}`:e.CODE_NO?`Bill_Code_${e.CODE_NO}`:`Bill_${t}`;case"member":return e.NAME?String(e.NAME).replace(/[^\w\s]/g,"").substring(0,20)||`Member_${t}`:e.FLAT_NO?`Member_Flat_${e.FLAT_NO}`:`Member_${t}`;case"receipt":return e.FLAT_NO?`Receipt_Flat_${e.FLAT_NO}`:`Receipt_${t}`;default:return`Record_${t}`}}generateFilename(e,t,r){const o=new Date().toISOString().split("T")[0],s=e?e.replace(/[^a-zA-Z0-9]/g,"_"):"Society",i=this.getReportDisplayName(t);return`${s}_${i}_${r==="multi"?"MultiSheet":"SingleSheet"}_${o}.xlsx`}getReportDisplayName(e){switch(e){case"receipt":return"ReceiptRegister";case"bill":return"BillRegister";case"member":return"MemberDetail";default:return"Report"}}isCurrencyField(e){return["TOTAL","GR_TOTAL","ARREARS","ADVANCE","INTEREST","OUTST_BAL","REC_AMT","REC_AMT1","REC_AMT2","REC_AMT3","MAINT_CHG","WATER_CHG","BMC_TAX","ELECT_CHG","SALARY","OTHER_CHG1","OTHER_CHG2","SINK_FUND","REP_FUND","LET_OUT_CH","PARK_CHG","BLDG_FUND","LEGAL_CHG","PAINT_FD","MAPLE_CHG","LIFT_MAINT","INT_ARREAR"].includes(e)}isDateField(e){return["BILL_DATE","REC_DATE","DUE_DATE","CHEQUE_DT1","CHEQUE_DT2","CHEQUE_DT3"].includes(e)}formatCurrency(e){const t=parseFloat(e);return isNaN(t)?"0":`${t.toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2})}`}formatDate(e){if(!e)return"";try{const t=new Date(e);return isNaN(t.getTime())?e:t.toLocaleDateString("en-IN")}catch{return e}}downloadExcelFile(e,t){const r=new Blob([e],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),o=window.URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(o)}}const E=async f=>await new T().generateSpecializedReport(f);export{T as default,E as generateSpecializedReport};
